"""
Модуль моделей пользователей и ролей для SQLAlchemy ORM.

Этот модуль определяет модели для системы управления пользователями, включая:
- Модель User для хранения информации о пользователях
- Модель Role для хранения ролей системы
- Модель UserRole для связи пользователей с ролями (многие-ко-многим)
- Перечисление GenderEnum для определения пола пользователя

Структура базы данных поддерживает гибкую систему ролей, где каждый пользователь
может иметь несколько ролей с возможностью активации/деактивации каждой роли.

Ключевые особенности:
    - Подтверждение email через флаг is_active
    - Блокировка пользователей через флаг is_blocked
    - Автоматическое отслеживание дат создания и обновления
    - Гибкая система ролей с промежуточной таблицей

Зависимости:
    sqlalchemy: Column, Integer, String, Boolean, DateTime, ForeignKey
    sqlalchemy.orm: relationship
    sqlalchemy.sql: func для SQL функций
    enum: Enum для перечислений
    datetime: datetime для временных меток
    app.db.session: Base класс для SQLAlchemy моделей

Обработчики событий:
    before_update: Декоратор @event.listens_for отслеживает события обновления
        и гарантирует, что поле updated_at всегда будет установлено в текущее время
        при любом изменении записи пользователя. Это обеспечивает точное отслеживание
        последней активности даже при обновлениях, которые не затрагивают это поле явно.
"""

import enum
from sqlalchemy import Column, Integer, String, Boolean, DateTime, ForeignKey, Enum as SAEnum, event
from sqlalchemy.orm import relationship
from sqlalchemy.sql import func

from app.db.session import Base


class GenderEnum(str, enum.Enum):
    """
    Перечисление для пола пользователя.

    Значения:
        male (str): "male" - мужской пол
        female (str): "female" - женский пол

    Используется в поле gender модели User для ограничения допустимых значений.
    Сохраняется как строка в базе данных.
    """

    male = "male"
    female = "female"

class User(Base):
    """
    Модель пользователя системы AI_PDF.

    Таблица: users

    Представляет зарегистрированного пользователя системы и хранит:
    - Учетные данные (email, хеш пароля)
    - Персональные данные (имя, фамилия, пол)
    - Статусы аккаунта (активность, блокировка)
    - Временные метки создания и обновления
    - Связи с документами и ролями пользователя

    Все поля являются обязательными при создании пользователя. Email должен быть
    уникальным и используется для аутентификации. Пароль хранится в зашифрованном
    виде с использованием алгоритма Argon2.

    Статусы:
        - is_active: False при регистрации, становится True после подтверждения email
        - is_blocked: Используется для временной или постоянной блокировки доступа

    Временные метки:
        - created_at: Устанавливается автоматически при создании записи
        - updated_at: Автоматически обновляется при любом изменении записи

    Связи:
        - user_roles: Связь с промежуточной таблицей UserRole (многие-ко-многим с Role)
        - documents: Все документы, загруженные пользователем (один-ко-многим)

    Атрибуты:
        id (int): Первичный ключ, уникальный идентификатор пользователя.
                  Автоинкремент, используется для всех связей и поиска.

        email (str): Email адрес пользователя. Должен быть уникальным в системе.
            Максимальная длина: Определяется настройками базы данных (обычно 255).
            Не может быть NULL. Используется для входа в систему и уведомлений.
            Пример: "user@example.com"

        password_hash (str): Хеш пароля пользователя, созданный с использованием Argon2.
            Не может быть NULL. Хранится в зашифрованном виде для безопасности.
            Длина: Определяется используемым алгоритмом хеширования (обычно 60+ символов).

        first_name (str): Имя пользователя. Обязательное поле при регистрации.
            Максимальная длина: 64 символа.
            Может содержать только буквы и допустимые символы.
            Пример: "Иван"

        last_name (str): Фамилия пользователя. Обязательное поле при регистрации.
            Максимальная длина: 64 символа.
            Может содержать только буквы и допустимые символы.
            Пример: "Иванов"

        gender (GenderEnum): Пол пользователя. Обязательное поле при регистрации.
            Тип: Enum (male/female). Использует строковое представление в базе данных.
            Допустимые значения: "male" (мужской), "female" (женский).

        is_blocked (bool): Флаг блокировки аккаунта администратором.
            По умолчанию: False (активен).
            При True: пользователь не может войти в систему и все его операции блокируются.
            Используется для временной или постоянной блокировки нарушителей.

        is_active (bool): Флаг подтверждения email и общей активности аккаунта.
            По умолчанию: False (неактивен при регистрации).
            При False: требуется подтверждение email, пользователь не может входить в систему.
            При True: аккаунт подтвержден, пользователь может использовать все функции системы.

        created_at (datetime): Дата и время создания учетной записи.
            По умолчанию: текущее время сервера базы данных (func.now()).
            Не может быть NULL. Не изменяется после создания.
            Формат: DateTime с временной зоной для корректной работы в разных часовых поясах.

        updated_at (datetime): Дата и время последнего обновления учетной записи.
            По умолчанию: текущее время сервера при создании (func.now()).
            Не может быть NULL. Автоматически обновляется при любом изменении записи.
            Формат: DateTime с временной зоной.
            Обновление происходит через триггер базы данных (onupdate) и обработчик событий.

    Отношения:
        user_roles (relationship): Связь один-ко-многим с промежуточной таблицей UserRole.
            back_populates: "user" - обратная связь из UserRole.
            Позволяет получить все назначенные пользователю роли через промежуточную таблицу.

        documents (relationship): Связь один-ко-многим с моделью Document.
            back_populates: "user" - обратная связь из Document.
            Позволяет получить все документы, загруженные пользователем.
            Используется для управления документами пользователя и проверки прав доступа.

    Индексы:
        id: Автоматически создается первичный ключ с индексом (быстрый поиск по ID).
        email: Уникальный индекс для быстрого поиска по email и обеспечения уникальности.

    Примечания:
        - Все текстовые поля используют кодировку UTF-8 для поддержки кириллицы и других языков.
        - Пароль никогда не хранится в открытом виде, только в виде хеша.
    """

    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    email = Column(String, unique=True, index=True, nullable=False)
    password_hash = Column(String, nullable=False, info={'verbose_name': 'хэш_пароля'})
    first_name = Column(String(64), nullable=False, info={'verbose_name': 'Имя'})
    last_name = Column(String(64), nullable=False, info={'verbose_name': 'Фамилия'})
    gender = Column(SAEnum(GenderEnum), nullable=False, info={'verbose_name': 'Пол'})
    is_blocked = Column(Boolean, default=False, nullable=False, info={'verbose_name': 'заблокирован'})
    is_active = Column(Boolean, default=False, info={'verbose_name': 'активен'})
    created_at = Column(DateTime(timezone=True), server_default=func.now(), nullable=False, info={'verbose_name': 'дата_создания'})
    updated_at = Column( DateTime(timezone=True), server_default=func.now(), onupdate=func.now(), nullable=False,
                         info={'verbose_name': 'дата_обновления'})

    user_roles = relationship("UserRole", back_populates="user")
    documents = relationship("Document", back_populates="user")


@event.listens_for(User, "before_update", propagate=True)
def _user_set_updated_at(mapper, connection, target):
    """
    Обработчик события before_update для модели User.

    Гарантирует, что поле updated_at всегда обновляется при любом изменении
    записи пользователя, даже если обновление не затрагивает это поле явно.

    Аргументы:
        mapper: Маппер SQLAlchemy
        connection: Соединение с базой данных
        target: Экземпляр модели User, который обновляется
    """
    target.updated_at = func.now()


class Role(Base):
    """
    Модель роли системы.

    Таблица: roles

    Хранит доступные роли в системе. Каждая роль имеет уникальное имя.
    Роли определяют права доступа пользователей к различным функциям системы.

    Поддерживаемые роли (вносятся вручную):
        guest: Гость - базовые права (по умолчанию при регистрации)
        manager: Менеджер - может загружать и управлять документами
        supervisor: Руководитель - доступ ко всем документам, статистике
        admin: Администратор - полный доступ ко всем функциям системы

    Атрибуты:
        id (int): Первичный ключ, уникальный идентификатор роли.
                  Автоинкремент, используется для связей с пользователями.

        name (str): Название роли.
            Уникальное, с индексом для быстрого поиска.
            Максимальная длина: 50 символов.
            Не может быть NULL.
            Примеры: "guest", "manager", "supervisor", "admin"

    Отношения:
        user_roles (relationship): Связь o2m с моделью UserRole.
            back_populates: "role" - обратная связь из UserRole.
            Позволяет получить всех пользователей с данной ролью.
    """

    __tablename__ = "roles"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(50), unique=True, index=True, nullable=False, info={'verbose_name': 'Название роли'})  # guest, manager, director, admin

    user_roles = relationship("UserRole", back_populates="role")

class UserRole(Base):
    """
    Промежуточная модель для связи пользователей и ролей.

    Таблица: user_roles

    Реализует связь m2m между User и Role с дополнительным
    атрибутом is_active для управления активностью роли у пользователя.
    Позволяет временно отключать роли без удаления связи.

    Атрибуты:
        id (int): Первичный ключ, уникальный идентификатор связи.
                  Автоинкремент.

        user_id (int): Идентификатор пользователя.
            Внешний ключ к таблице users.id.
            Не может быть NULL.

        role_id (int): Идентификатор роли.
            Внешний ключ к таблице roles.id.
            Не может быть NULL.

        is_active (bool): Флаг активности роли у пользователя.
            По умолчанию: True (активна).
            При False: роль временно отключена для пользователя.
            Позволяет временно отзывать права без удаления связи.

    Отношения:
        user (relationship): Связь m2o с моделью User.
            back_populates: "user_roles" - обратная связь из User.
            Позволяет получить пользователя из связи.

        role (relationship): Связь m2o с моделью Role.
            back_populates: "user_roles" - обратная связь из Role.
            Позволяет получить роль из связи.
    """

    __tablename__ = 'user_roles'

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey('users.id'), info={'verbose_name': 'id_пользователя'})
    role_id = Column(Integer, ForeignKey('roles.id'), info={'verbose_name': 'id_роли'})
    is_active = Column(Boolean, default=True, info={'verbose_name': 'активна'})

    user = relationship("User", back_populates="user_roles")
    role = relationship("Role", back_populates="user_roles")
